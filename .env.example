# =============================================================================
# StealthFlow Observability - Environment Configuration
# =============================================================================
#
# AUTOMATED DEPLOYMENT:
#   Run ./scripts/deploy-auto.sh for 100% automated setup.
#   The script will:
#   - Auto-generate API_KEYS if not set
#   - Deploy complete Docker stack (Redis + ES + MongoDB + API + Worker)
#   - Verify all services are healthy
#   - Display credentials and usage instructions
#
# MANUAL DEPLOYMENT:
#   docker-compose up -d
#
# All infrastructure services run inside Docker - no external dependencies!
#
# =============================================================================

# =============================================================================
# Node Environment
# =============================================================================

NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# =============================================================================
# Infrastructure Services (Docker Internal)
# =============================================================================
#
# These services run inside Docker and use internal hostnames.
# No need to change these for local development!
#

# Redis - Log streaming queue
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=0

# Elasticsearch - Log storage and search
ELASTICSEARCH_URL=http://elasticsearch:9200
ELASTICSEARCH_USERNAME=
ELASTICSEARCH_PASSWORD=
ELASTICSEARCH_TLS_VERIFY=false

# MongoDB - Metadata storage
MONGODB_URI=mongodb://mongodb:27017/observability

# =============================================================================
# Logging Configuration
# =============================================================================

# Redis Stream configuration
LOG_STREAM_NAME=logs:stream
LOG_CONSUMER_GROUP=stealthflow-log-workers
LOG_BATCH_SIZE=200
LOG_BLOCK_TIMEOUT_MS=2000

# Elasticsearch Index
LOG_INDEX_ALIAS=stealthflow_develop_logs

# =============================================================================
# API Authentication & Rate Limiting
# =============================================================================
#
# API_KEYS: Comma-separated list of valid API keys
#   - AUTO-GENERATED: deploy-auto.sh will generate 3 keys if this is empty
#   - MANUAL: Generate with: openssl rand -hex 32
#   - ROTATION: Add new keys, update clients, then remove old keys
#   - FORMAT: key1,key2,key3 (no spaces)
#
# Example (DO NOT USE IN PRODUCTION):
# API_KEYS=a1b2c3d4e5f6...,f6e5d4c3b2a1...,123456789abc...
#
# Leave empty or commented for auto-generation during deployment:
# API_KEYS=

# Rate Limiting Configuration
#   - WINDOW_MS: Time window in milliseconds (default: 60000 = 1 minute)
#   - MAX_REQUESTS: Max single log requests per window (default: 100)
#   - BATCH_MAX: Max batch log requests per window (default: 20)
#
# Uncomment to customize (or leave commented for defaults):
# RATE_LIMIT_WINDOW_MS=60000
# RATE_LIMIT_MAX_REQUESTS=100
# RATE_LIMIT_BATCH_MAX=20

# =============================================================================
# Fallback Logging
# =============================================================================
#
# When Redis/Elasticsearch are unavailable, logs are written to local files.
# These files are automatically cleaned up after FALLBACK_RETENTION_DAYS.
#

FALLBACK_LOG_DIR=/var/log/observability/fallback
FALLBACK_RETENTION_DAYS=7

# =============================================================================
# Resilience
# =============================================================================
#
# Circuit Breaker protects against cascading failures.
#   - THRESHOLD: Number of failures before opening circuit (default: 5)
#   - TIMEOUT: Time in ms before attempting recovery (default: 60000 = 1 min)
#

CIRCUIT_BREAKER_THRESHOLD=5
CIRCUIT_BREAKER_TIMEOUT=60000

# =============================================================================
# Docker Resource Limits
# =============================================================================
#
# Resource limits prevent services from consuming all server resources.
# Adjust based on your server specs (16 vCPU / 64 GB recommended).
#
# Total allocation example:
#   - API: 1 CPU / 512MB
#   - Worker: 1 CPU / 1GB
#   - Redis: 1 CPU / 1GB
#   - Elasticsearch: 4 CPU / 8GB (heap: 4GB)
#   - MongoDB: 2 CPU / 4GB
#   - Total: ~9 CPU / ~14.5GB (leaves ~7 CPU / ~49GB for OS/other)
#
# =============================================================================

# Observability API Server
API_CPUS=1.0
API_MEM=512m
API_CPUS_RESERVATION=0.5
API_MEM_RESERVATION=256m

# Log Worker
WORKER_CPUS=1.0
WORKER_MEM=1g
WORKER_CPUS_RESERVATION=0.5
WORKER_MEM_RESERVATION=512m

# Redis
REDIS_CPUS=1.0
REDIS_MEM=1g
REDIS_CPUS_RESERVATION=0.25
REDIS_MEM_RESERVATION=256m
REDIS_MAXMEMORY=512mb

# Elasticsearch
ES_CPUS=4.0
ES_MEM=8g
ES_CPUS_RESERVATION=2.0
ES_MEM_RESERVATION=4g
ES_HEAP=4g

# MongoDB
MONGO_CPUS=2.0
MONGO_MEM=4g
MONGO_CPUS_RESERVATION=1.0
MONGO_MEM_RESERVATION=2g
